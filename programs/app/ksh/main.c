#include "stdio.h"
#include "unistd.h"
#include "string.h"
#include "const.h"

char logo[] = {
  0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x5f, 0x20, 0x20, 0x5f, 0x20,
  0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x5f, 0x5f,
  0x5f, 0x20, 0x20, 0x5f, 0x5f, 0x5f, 0x20, 0x20, 0x20, 0x5f, 0x20, 0x20,
  0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x5f, 0x20, 0x20,
  0x5f, 0x5f, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
  0x20, 0x20, 0x20, 0x20, 0x20, 0x5f, 0x5f, 0x20, 0x20, 0x20, 0x20, 0x20,
  0x20, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x7c, 0x20, 0x5c, 0x7c,
  0x20, 0x7c, 0x5f, 0x5f, 0x20, 0x5f, 0x20, 0x5f, 0x20, 0x5f, 0x20, 0x2f,
  0x20, 0x5f, 0x20, 0x5c, 0x2f, 0x20, 0x5f, 0x5f, 0x7c, 0x20, 0x7c, 0x20,
  0x7c, 0x5f, 0x5f, 0x20, 0x5f, 0x20, 0x20, 0x5f, 0x20, 0x20, 0x7c, 0x20,
  0x7c, 0x2f, 0x20, 0x2f, 0x5f, 0x5f, 0x5f, 0x20, 0x5f, 0x20, 0x5f, 0x20,
  0x20, 0x5f, 0x5f, 0x20, 0x5f, 0x20, 0x2f, 0x20, 0x5f, 0x7c, 0x5f, 0x20,
  0x20, 0x5f, 0x20, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x7c, 0x20,
  0x2e, 0x60, 0x20, 0x2f, 0x20, 0x5f, 0x60, 0x20, 0x7c, 0x20, 0x27, 0x20,
  0x5c, 0x20, 0x28, 0x5f, 0x29, 0x20, 0x5c, 0x5f, 0x5f, 0x20, 0x5c, 0x20,
  0x7c, 0x20, 0x27, 0x5f, 0x20, 0x5c, 0x20, 0x7c, 0x7c, 0x20, 0x7c, 0x20,
  0x7c, 0x20, 0x27, 0x20, 0x3c, 0x2f, 0x20, 0x5f, 0x20, 0x5c, 0x20, 0x27,
  0x20, 0x5c, 0x2f, 0x20, 0x5f, 0x60, 0x20, 0x7c, 0x20, 0x20, 0x5f, 0x7c,
  0x20, 0x7c, 0x7c, 0x20, 0x7c, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
  0x7c, 0x5f, 0x7c, 0x5c, 0x5f, 0x5c, 0x5f, 0x5f, 0x2c, 0x5f, 0x7c, 0x5f,
  0x7c, 0x7c, 0x5f, 0x5c, 0x5f, 0x5f, 0x5f, 0x2f, 0x7c, 0x5f, 0x5f, 0x5f,
  0x2f, 0x20, 0x7c, 0x5f, 0x2e, 0x5f, 0x5f, 0x2f, 0x5c, 0x5f, 0x2c, 0x20,
  0x7c, 0x20, 0x7c, 0x5f, 0x7c, 0x5c, 0x5f, 0x5c, 0x5f, 0x5f, 0x5f, 0x2f,
  0x5f, 0x7c, 0x7c, 0x5f, 0x5c, 0x5f, 0x5f, 0x2c, 0x20, 0x7c, 0x5f, 0x7c,
  0x20, 0x20, 0x5c, 0x5f, 0x2c, 0x20, 0x7c, 0x0a, 0x20, 0x20, 0x20, 0x20,
  0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
  0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
  0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x7c, 0x5f,
  0x5f, 0x2f, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
  0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x7c, 0x5f, 0x5f, 0x5f, 0x2f, 0x20,
  0x20, 0x20, 0x20, 0x20, 0x7c, 0x5f, 0x5f, 0x2f, 0x20, 0x0a, 0x00
};

#define MAX_LEN 256
#define MAXARG  16
uint8_t buf[MAX_LEN];
uint8_t path[MAX_LEN];

static inline
bool isChar(char c)
{
    if ((c >= 'a' && c <= 'z') ||
        (c >= 'A' && c <= 'Z') ||
        (c >= '0' && c <= '9') ||
        c == '/' || c == '.') {
        return true;
    }
    return false;
}

char *parse(uint8_t *buf, void *argv)
{
    char *p = (char *)buf;

    while (!isChar(*p) && *p != '\0') *(p++) = '\0';

    char *q = p;
    while (isChar(*q)) q++;

    bool flag = false;
    char **t = (char **)argv;

    while (*q != '\0') {
        if (!flag && isChar(*q)) {
            *(t++) = q;
        }

        if (isChar(*q)) {
            flag = true;
        } else {
            *q = '\0';
            flag = false;
        }
        q++;
    }

    return p;
}

char *path_extend(char *filename)
{
    int len = strlen(filename);
    if (len == 0) {
        return filename;
    }

    if (len >= 1) {
        if (filename[0] == '/') {
            return filename;
        }
    }

    if (len >= 2) {
        if (filename[0] == '.' && filename[1] == '/') {
            return filename;
        }
    }

    strcpy((char *)path, "/bin/");
    strcpy((char *)&path[5], filename);
    return (char *)path;
}

bool buildin(char *filename, char *argv[]);

int main(int argc, char *argv[])
{
    printf(logo);

    while (true) {
        printf("# ");

        int nread = read(STDIN_FILENO, buf, 255);
        buf[nread] = 0;

        char *argv[MAXARG];
        int i;
        for (i = 0; i < MAXARG; ++i) argv[i] = NULL;

        char *filename = parse(buf, argv);

        if (!strlen(filename)) {
            continue;
        }

        // check build-in first
        if (buildin(filename, argv)) {
            continue;
        }

        filename = path_extend(filename);

        pid_t pid = fork();
        if (pid == 0) {
            int err = exec(filename, argv);
            if (err == -1) {
                printf("-ksh: %s: No such file or directory\n", filename);
            } else if (err == -2) {
                printf("-ksh: %s: is a directory\n", filename);
            } else if (err == -500) {
                printf("-ksh: %s: Can not be excuted\n", filename);
            }
        } else {
            waitpid(pid);
        }
    }

    return 0;
}
